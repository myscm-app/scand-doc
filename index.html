<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SEKTE DELIVERY SCANNER</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a', // Slate 900
                        secondary: '#334155', // Slate 700
                        accent: '#3b82f6', // Blue 500
                        success: '#10b981', // Emerald 500
                        danger: '#ef4444', // Red 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- jsPDF (PDF Generator) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- JSZip & FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Tesseract.js -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; /* Lightest Blue */
            background-image: 
                radial-gradient(at 0% 0%, rgba(219, 234, 254, 0.6) 0, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(224, 231, 255, 0.6) 0, transparent 50%);
            background-size: 100% 100%;
            background-attachment: fixed;
            color: #334155; /* Softer text color */
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .input-modern {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .input-modern:focus {
            background: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, transparent, #3b82f6, transparent);
            box-shadow: 0 0 10px #3b82f6;
            animation: scan 2s linear infinite;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        button, select, input { touch-action: manipulation; }
    </style>
    
    <!-- FIREBASE MODULE IMPORTS -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        window.firebaseModules = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, 
            onAuthStateChanged, getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, serverTimestamp, onSnapshot
        };
    </script>
</head>
<body class="antialiased min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, 
            onAuthStateChanged, getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, serverTimestamp, onSnapshot
        } = window.firebaseModules || {};

        // --- ICONS (Styled) ---
        const SvgIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {props.children}
            </svg>
        );

        const Icons = {
            Camera: () => <SvgIcon><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3z"/><circle cx="12" cy="13" r="3"/></SvgIcon>,
            Download: () => <SvgIcon><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></SvgIcon>,
            Refresh: () => <SvgIcon><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></SvgIcon>,
            Check: () => <SvgIcon><polyline points="20 6 9 17 4 12"/></SvgIcon>,
            Calendar: () => <SvgIcon><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></SvgIcon>,
            Tag: () => <SvgIcon><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></SvgIcon>,
            Loader: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>,
            Close: () => <SvgIcon><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></SvgIcon>,
            Key: () => <SvgIcon><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></SvgIcon>,
            Brain: () => <SvgIcon><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></SvgIcon>,
            Cloud: () => <SvgIcon><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="12 5 12 19 8 15 16 15"/></SvgIcon>,
            List: () => <SvgIcon><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></SvgIcon>,
            Home: () => <SvgIcon><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></SvgIcon>,
            Zip: () => <SvgIcon><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></SvgIcon>,
            Edit: () => <SvgIcon><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></SvgIcon>,
            Trash: () => <SvgIcon><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></SvgIcon>,
            Lock: () => <SvgIcon><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></SvgIcon>,
            User: () => <SvgIcon><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></SvgIcon>
        };

        // --- Helper Functions ---
        const generatePDFDoc = (data, imageBase64) => {
             if (!window.jspdf) return null;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Modern Header
            doc.setFillColor(41, 58, 86); // Corporate Blue
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("ARSIP SURAT JALAN", 105, 20, { align: "center" });
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("SEKTE DELIVERY DIGITAL LOG", 105, 30, { align: "center" });

            // Content
            doc.setTextColor(40, 40, 40);
            
            let y = 60;
            const lineHeight = 10;
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("DETAIL DOKUMEN", 20, y);
            y += 8;
            doc.setDrawColor(200, 200, 200);
            doc.line(20, y, 190, y);
            y += 12;

            const addField = (label, value) => {
                doc.setFont("helvetica", "bold");
                doc.text(label, 20, y);
                doc.setFont("helvetica", "normal");
                doc.text(": " + value, 60, y);
                y += lineHeight;
            };

            addField("No. Surat Jalan", data.noSuratJalan || '-');
            addField("Kategori", data.kategori);
            addField("Bulan", data.bulan);
            addField("Tanggal Scan", new Date().toLocaleDateString('id-ID'));

            // Image
            if (imageBase64) {
                y += 10;
                doc.setFont("helvetica", "bold");
                doc.text("BUKTI FISIK", 20, y);
                y += 5;
                doc.line(20, y, 190, y);
                y += 10;

                const imgProps = doc.getImageProperties(imageBase64);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const availableWidth = pdfWidth - 40;
                const imgHeight = (imgProps.height * availableWidth) / imgProps.width;
                
                // Check if image needs new page
                if (y + imgHeight > 280) {
                    doc.addPage();
                    y = 20;
                }

                doc.addImage(imageBase64, 'JPEG', 20, y, availableWidth, imgHeight);
            }
            return doc;
        };

        const createAndDownloadPDF = (data, imageBase64) => {
            const doc = generatePDFDoc(data, imageBase64);
            if (!doc) {
                alert("Library PDF belum siap.");
                return;
            }
            const fileName = data.noSuratJalan 
                ? `${data.noSuratJalan.replace(/[^a-zA-Z0-9\-_]/g, '_')}.pdf` 
                : 'Surat_Jalan_Scan.pdf';
            doc.save(fileName);
        };

        // --- Auth Modal ---
        const AuthModal = ({ onClose, onSuccess, title }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (username === 'delivery' && password === 'tanzela0308') {
                    onSuccess();
                } else {
                    setError('Username atau Password salah!');
                }
            };

            return (
                <div className="fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl space-y-4">
                        <div className="text-center">
                            <div className="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-2"><Icons.Lock /></div>
                            <h3 className="font-bold text-lg text-slate-800">{title || "Akses Admin Diperlukan"}</h3>
                            <p className="text-xs text-slate-500">Silakan login untuk melanjutkan.</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-slate-500 uppercase">Username</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-400"><Icons.User className="w-4 h-4"/></span>
                                    <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full p-2 pl-9 rounded-lg border border-slate-200 bg-slate-50 text-sm focus:ring-2 focus:ring-red-500 outline-none" placeholder="Username" autoFocus />
                                </div>
                            </div>
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-slate-500 uppercase">Password</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-400"><Icons.Key className="w-4 h-4"/></span>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-2 pl-9 rounded-lg border border-slate-200 bg-slate-50 text-sm focus:ring-2 focus:ring-red-500 outline-none" placeholder="Password" />
                                </div>
                            </div>
                            {error && <div className="text-xs text-red-600 font-bold text-center bg-red-50 p-2 rounded">{error}</div>}
                            <div className="flex gap-2 pt-2">
                                <button type="button" onClick={onClose} className="flex-1 py-2 text-slate-500 text-sm font-bold hover:bg-slate-100 rounded-lg">Batal</button>
                                <button type="submit" className="flex-1 py-2 bg-red-600 text-white text-sm font-bold rounded-lg shadow hover:bg-red-700">Masuk</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Edit Modal ---
        const EditModal = ({ item, onClose, onSave }) => {
            const [formData, setFormData] = useState({ ...item });
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const categories = ["MI", "PASIR", "SLAG"];

            const handleSubmit = () => {
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl space-y-4">
                        <h3 className="font-bold text-lg text-slate-800 border-b pb-2 flex gap-2 items-center"><Icons.Edit className="text-blue-600"/> Edit Laporan</h3>
                        <div className="space-y-3">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">No Surat Jalan</label>
                                <input type="text" value={formData.noSuratJalan} onChange={(e) => setFormData({...formData, noSuratJalan: e.target.value})} className="w-full p-2 border rounded-lg text-sm font-mono font-bold uppercase" />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Kategori</label>
                                    <select value={formData.kategori} onChange={(e) => setFormData({...formData, kategori: e.target.value})} className="w-full p-2 border rounded-lg text-sm">
                                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Bulan</label>
                                    <select value={formData.bulan} onChange={(e) => setFormData({...formData, bulan: e.target.value})} className="w-full p-2 border rounded-lg text-sm">
                                        {months.map(m => <option key={m} value={m}>{m}</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 pt-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 text-sm font-bold hover:bg-slate-100 rounded-lg">Batal</button>
                            <button onClick={handleSubmit} className="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg shadow hover:bg-blue-700">Simpan Perubahan</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Camera Modal ---
        const CameraModal = ({ onCapture, onClose }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [isStreamReady, setIsStreamReady] = useState(false);

            useEffect(() => {
                let stream = null;
                const startCamera = async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
                        });
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            videoRef.current.onloadedmetadata = () => { setIsStreamReady(true); videoRef.current.play(); };
                        }
                    } catch (err) { console.error(err); alert("Gagal akses kamera."); onClose(); }
                };
                startCamera();
                return () => { if (stream) stream.getTracks().forEach(track => track.stop()); };
            }, [onClose]);

            const takePhoto = () => {
                if (!videoRef.current || !canvasRef.current) return;
                const video = videoRef.current;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const w = canvas.width, h = canvas.height;
                const cropW = w * 0.9, cropH = cropW / 1.414;
                const cropX = (w - cropW) / 2, cropY = (h - cropH) / 2;
                
                const finalCvs = document.createElement('canvas');
                finalCvs.width = cropW; finalCvs.height = cropH;
                finalCvs.getContext('2d').drawImage(canvas, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
                onCapture(finalCvs.toDataURL('image/jpeg', 0.85));
            };

            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex flex-col backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="relative flex-1 flex items-center justify-center overflow-hidden">
                        <video ref={videoRef} className="absolute min-w-full min-h-full object-cover" playsInline muted />
                        <div className="absolute inset-0 bg-black/40"></div>
                        <div className="absolute w-[90%] aspect-[1.414/1] z-10 pointer-events-none border-2 border-white/30 rounded-lg">
                            <div className="absolute top-4 right-4 bg-black/60 backdrop-blur px-3 py-1 rounded-full border border-white/10 flex items-center gap-2"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span className="text-[10px] font-bold text-white uppercase tracking-wider">Area No SJ</span></div>
                        </div>
                    </div>
                    <div className="h-28 bg-black/80 flex items-center justify-around px-8 pb-safe">
                        <button onClick={onClose} className="p-4 rounded-full bg-slate-800 text-white hover:bg-slate-700 transition-colors"><Icons.Close /></button>
                        <button onClick={takePhoto} disabled={!isStreamReady} className="w-20 h-20 rounded-full border-[6px] border-white/20 flex items-center justify-center bg-transparent active:scale-95 transition-all"><div className="w-16 h-16 bg-white rounded-full shadow-[0_0_20px_rgba(255,255,255,0.5)]"></div></button>
                        <div className="w-14"></div>
                    </div>
                    <canvas ref={canvasRef} className="hidden"></canvas>
                </div>
            );
        };

        const ReportsView = ({ db, user, appId }) => {
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filterMonth, setFilterMonth] = useState('Semua');
            const [searchTerm, setSearchTerm] = useState('');
            const [isBatchDownloading, setIsBatchDownloading] = useState(false);
            
            const [selectionMode, setSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [authAction, setAuthAction] = useState(null);
            const [showEditModal, setShowEditModal] = useState(false);
            const [editingItem, setEditingItem] = useState(null);

            const months = ["Semua", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            useEffect(() => {
                if (!db || !user) { setLoading(false); return; }
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'surat_jalan_logs');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setLogs(data);
                    setLoading(false);
                }, () => setLoading(false));
                return () => unsubscribe();
            }, [db, user, appId]);

            const filteredLogs = logs.filter(log => {
                const matchMonth = filterMonth === 'Semua' || log.bulan === filterMonth;
                const matchSearch = (log.noSuratJalan || '').toLowerCase().includes(searchTerm.toLowerCase());
                return matchMonth && matchSearch;
            });

            const toggleSelection = (id) => {
                const newSet = new Set(selectedIds);
                if (newSet.has(id)) newSet.delete(id); else newSet.add(id);
                setSelectedIds(newSet);
            };

            const initiateAuth = (action) => { setAuthAction(action); setShowAuthModal(true); };

            const handleAuthSuccess = async () => {
                setShowAuthModal(false);
                if (!authAction) return;
                const publicCol = 'surat_jalan_logs'; 
                try {
                    if (authAction.type === 'delete_one') {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', publicCol, authAction.target));
                        alert("File berhasil dihapus dari Database Pusat.");
                    } else if (authAction.type === 'delete_many') {
                        for (const id of Array.from(selectedIds)) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', publicCol, id));
                        alert(`${selectedIds.size} file berhasil dihapus.`); setSelectionMode(false); setSelectedIds(new Set());
                    } else if (authAction.type === 'delete_all') {
                        for (const log of filteredLogs) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', publicCol, log.id));
                        alert("Semua data berhasil dihapus.");
                    } else if (authAction.type === 'edit') {
                        setEditingItem(authAction.target); setShowEditModal(true);
                    }
                } catch (err) { console.error(err); alert("Terjadi kesalahan."); }
            };

            const handleSaveEdit = async (newData) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'surat_jalan_logs', newData.id), { noSuratJalan: newData.noSuratJalan, kategori: newData.kategori, bulan: newData.bulan });
                    setShowEditModal(false); setEditingItem(null); alert("Data berhasil diperbarui!");
                } catch (err) { console.error(err); alert("Gagal update data."); }
            };

            const handleBatchDownload = async () => {
                if (filteredLogs.length === 0) return;
                setIsBatchDownloading(true);
                try {
                    const zip = new JSZip();
                    const folderName = filterMonth === 'Semua' ? 'Laporan_Semua' : `Laporan_${filterMonth}`;
                    const folder = zip.folder(folderName);
                    let count = 0;
                    const targetLogs = selectionMode && selectedIds.size > 0 ? filteredLogs.filter(l => selectedIds.has(l.id)) : filteredLogs;
                    targetLogs.forEach((log, index) => {
                        const doc = generatePDFDoc(log, log.imageBase64);
                        if(doc) {
                            const fileName = log.noSuratJalan ? `${log.noSuratJalan.replace(/[^a-zA-Z0-9\-_]/g, '_')}.pdf` : `SJ_${index}.pdf`;
                            folder.file(fileName, doc.output('blob'));
                            count++;
                        }
                    });
                    if(count > 0) {
                        const content = await zip.generateAsync({ type: "blob" });
                        saveAs(content, `${folderName}.zip`);
                        alert(`Berhasil mendownload ${count} file.`);
                    }
                } catch (e) { alert("Gagal ZIP"); }
                setIsBatchDownloading(false);
            };

            if (loading) return <div className="p-10 text-center text-slate-400 flex flex-col items-center gap-2"><Icons.Loader /><span className="text-sm">Memuat data...</span></div>;
            if (!user) return <div className="p-10 text-center text-slate-400 bg-white/50 rounded-xl m-4 border border-white/20">Mode Offline (Data Lokal Saja)</div>;

            return (
                <div className="space-y-6 pb-24">
                    {showAuthModal && <AuthModal title="Otorisasi Admin" onClose={() => setShowAuthModal(false)} onSuccess={handleAuthSuccess} />}
                    {showEditModal && editingItem && <EditModal item={editingItem} onClose={() => setShowEditModal(false)} onSave={handleSaveEdit} />}

                     <div className="glass-panel p-5 rounded-2xl space-y-4 relative overflow-hidden shadow-sm">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <h2 className="font-bold text-slate-700 flex gap-2 items-center text-lg"><Icons.List className="text-accent"/> {selectionMode ? `Dipilih (${selectedIds.size})` : 'Filter Laporan'}</h2>
                            <div className="flex gap-2 w-full md:w-auto justify-end">
                                {selectionMode ? (
                                    <>
                                        <button onClick={() => { setSelectionMode(false); setSelectedIds(new Set()); }} className="text-xs font-bold text-slate-500 px-4 py-2 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">Batal</button>
                                        <button onClick={() => initiateAuth({ type: 'delete_many' })} disabled={selectedIds.size === 0} className="text-xs font-bold text-white px-4 py-2 bg-red-500 rounded-lg shadow hover:bg-red-600 disabled:opacity-50 flex items-center gap-2 transition-all"><Icons.Trash className="w-3 h-3"/> Hapus</button>
                                    </>
                                ) : (
                                    <button onClick={() => setSelectionMode(true)} className="text-xs font-bold text-blue-600 bg-blue-50 px-4 py-2 rounded-lg border border-blue-100 hover:bg-blue-100 transition-all">Pilih / Hapus Banyak</button>
                                )}
                            </div>
                        </div>

                        {!selectionMode && (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Bulan</label>
                                        <select value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="w-full p-2.5 text-sm rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-accent outline-none hover:bg-white transition-colors">{months.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                    </div>
                                    <div className="space-y-1 lg:col-span-3 md:col-span-1">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Pencarian</label>
                                        <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Cari No Surat Jalan..." className="w-full p-2.5 text-sm rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-accent outline-none hover:bg-white transition-colors" />
                                    </div>
                                </div>
                                <div className="flex flex-col md:flex-row justify-between items-center border-t border-slate-100 pt-3 gap-3">
                                    <div className="text-xs text-slate-400 font-medium">Total: {filteredLogs.length} File Ditemukan</div>
                                    <div className="flex gap-2 w-full md:w-auto justify-end">
                                        <button onClick={handleBatchDownload} disabled={isBatchDownloading || filteredLogs.length === 0} className="flex-1 md:flex-none gap-2 px-4 py-2 rounded-lg text-xs font-bold bg-blue-600 text-white shadow-lg shadow-blue-200 hover:bg-blue-700 disabled:opacity-50 transition-all flex items-center justify-center">
                                            {isBatchDownloading ? <Icons.Loader /> : <><Icons.Zip /> Download ZIP</>}
                                        </button>
                                        <button onClick={() => initiateAuth({ type: 'delete_all' })} disabled={filteredLogs.length === 0} className="flex-1 md:flex-none gap-2 px-4 py-2 rounded-lg text-xs font-bold bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 disabled:opacity-50 transition-all flex items-center justify-center">
                                            <Icons.Trash className="w-3 h-3" /> Hapus Semua
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {filteredLogs.length === 0 ? (
                            <div className="col-span-full text-center py-16 text-slate-400 flex flex-col items-center justify-center bg-white/50 rounded-2xl border border-dashed border-slate-200">
                                <Icons.List className="w-12 h-12 mb-3 opacity-20"/>
                                <span>Tidak ada data ditemukan</span>
                            </div>
                        ) : (
                            filteredLogs.map(log => (
                                <div key={log.id} className={`bg-white p-4 rounded-xl shadow-sm border transition-all flex gap-4 items-center group ${selectionMode && selectedIds.has(log.id) ? 'border-blue-500 bg-blue-50/30 ring-2 ring-blue-500/20' : 'border-slate-100 hover:shadow-md hover:border-slate-300'}`} onClick={() => selectionMode && toggleSelection(log.id)}>
                                    {selectionMode && (
                                        <div className={`w-5 h-5 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${selectedIds.has(log.id) ? 'bg-blue-500 border-blue-500 text-white' : 'border-slate-300 bg-white'}`}>
                                            {selectedIds.has(log.id) && <Icons.Check className="w-3 h-3" />}
                                        </div>
                                    )}
                                    <div className="w-16 h-16 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0 border border-slate-200 flex items-center justify-center relative">
                                        {log.imageBase64 ? <img src={log.imageBase64} alt="Preview" className="w-full h-full object-cover transition-transform group-hover:scale-110"/> : <span className="text-[10px] text-slate-400">No IMG</span>}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <h4 className="font-bold text-sm text-slate-800 truncate mb-1" title={log.noSuratJalan}>{log.noSuratJalan}</h4>
                                        <div className="flex flex-wrap gap-1 mb-1">
                                            <span className="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full border border-blue-100">{log.kategori}</span>
                                            <span className="text-[10px] bg-slate-50 text-slate-500 px-2 py-0.5 rounded-full border border-slate-100">{log.bulan}</span>
                                        </div>
                                        <p className="text-[10px] text-slate-400">{log.createdAt ? new Date(log.createdAt.seconds * 1000).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit'}) : 'Baru saja'}</p>
                                    </div>
                                    {!selectionMode && (
                                        <div className="flex flex-col gap-1">
                                            <button onClick={(e) => { e.stopPropagation(); createAndDownloadPDF(log, log.imageBase64); }} className="p-2 text-white bg-emerald-500 rounded-lg shadow-sm hover:bg-emerald-600 transition-all" title="Download"><Icons.Download className="w-4 h-4" /></button>
                                            <div className="flex gap-1">
                                                <button onClick={(e) => { e.stopPropagation(); initiateAuth({ type: 'edit', target: log }); }} className="p-2 text-slate-400 bg-slate-50 rounded-lg hover:text-blue-600 hover:bg-blue-50 transition-all" title="Edit"><Icons.Edit className="w-3 h-3" /></button>
                                                <button onClick={(e) => { e.stopPropagation(); initiateAuth({ type: 'delete_one', target: log.id }); }} className="p-2 text-slate-400 bg-slate-50 rounded-lg hover:text-red-600 hover:bg-red-50 transition-all" title="Hapus"><Icons.Trash className="w-3 h-3" /></button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const ScannerView = ({ user, db, appId, apiKey, setApiKey, provider, setProvider, showSettings, setShowSettings, setActiveTab }) => {
            const [image, setImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [showCamera, setShowCamera] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [data, setData] = useState({ noSuratJalan: '', bulan: new Date().toLocaleString('id-ID', { month: 'long' }), kategori: 'MI' });
            
            const [manualYear, setManualYear] = useState(new Date().getFullYear().toString());
            const [manualSeq, setManualSeq] = useState('');
            const monthMap = { "Januari": "01", "Februari": "02", "Maret": "03", "April": "04", "Mei": "05", "Juni": "06", "Juli": "07", "Agustus": "08", "September": "09", "Oktober": "10", "November": "11", "Desember": "12" };

            useEffect(() => {
                if (manualSeq.length > 0) {
                    const mm = monthMap[data.bulan] || "01";
                    setData(prev => ({ ...prev, noSuratJalan: `SDO-MKI/${mm}/${manualYear}/${manualSeq}` }));
                }
            }, [manualSeq, manualYear, data.bulan]);

            const processImage = async (imgData) => {
                if (provider !== 'tesseract' && !apiKey) { alert("API Key diperlukan!"); setShowSettings(true); return; }
                setIsProcessing(true); setData(prev => ({ ...prev, noSuratJalan: '' })); setManualSeq('');

                try {
                    const img = new Image(); img.src = imgData; await new Promise(r => img.onload = r);
                    const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                    const MAX = 1600; let w=img.width, h=img.height;
                    if(w>MAX){h*=MAX/w; w=MAX;} cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                    const optData = cvs.toDataURL('image/jpeg', 0.95);

                    let resText = "";
                    const prompt = "Baca teks pada dokumen ini. Cari dan ekstrak Nomor Surat Jalan (Delivery Note No). Format biasanya diawali dengan 'SDO-MKI' (contoh: SDO-MKI-12345 atau SDO-MKI/01/24/...). Abaikan teks header seperti 'OBSERVATION' atau 'RESERVATION'. Hanya kembalikan nomornya saja.";

                    if (provider === 'tesseract') {
                        if(!window.Tesseract) throw new Error("Load Tesseract");
                        const res = await window.Tesseract.recognize(optData, 'ind'); resText = res.data.text;
                    } else if (provider === 'gemini') {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                        const req = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt},{inline_data:{mime_type:"image/jpeg",data:optData.split(',')[1]}}]}]}) });
                        const json = await req.json(); if(json.candidates) resText = json.candidates[0].content.parts[0].text;
                    } else {
                        const req = await fetch("https://api.openai.com/v1/chat/completions", { method:'POST', headers:{"Content-Type":"application/json","Authorization":`Bearer ${apiKey}`}, body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"user",content:[{type:"text",text:prompt},{type:"image_url",image_url:{url:optData}}]}],max_tokens:100}) });
                        const json = await req.json(); resText = json.choices[0].message.content;
                    }

                    let clean = resText.replace(/\*\*/g, '').replace(/\n/g, ' ').trim();
                    const match = clean.match(/([S5]D[O0]\s?[\-_]?\s?MK[I1l]\s?[\-_/]?\s?[A-Z0-9\-\/ ]{3,})/i);
                    let final = "";
                    if (match) {
                        let raw = match[0].toUpperCase().replace(/\s/g, '').replace(/^5/,'S').replace(/D0/,'DO').replace(/MK1|MKL/,'MKI');
                        const idx = raw.indexOf('MKI');
                        if (idx !== -1) {
                            let sfx = raw.substring(idx+3);
                            if (/^[\-_]+/.test(sfx)) sfx = sfx.replace(/^[\-_]+/, '-');
                            else if (!sfx.startsWith('/') && !sfx.startsWith('-')) sfx = '-' + sfx;
                            final = 'SDO-MKI' + sfx;
                        } else final = raw;
                    } else {
                        const cand = clean.split(' ').find(w => w.length>=8 && /\d/.test(w) && /[A-Z]/.test(w) && !w.includes('VATION'));
                        if(cand) final = cand;
                    }
                    if(final.includes("VATION") || final.length < 5) final = "";
                    if(!final) alert("No. Surat Jalan tidak ditemukan.\nSilakan input manual di bawah.");
                    setData(prev => ({ ...prev, noSuratJalan: final }));

                } catch (e) { console.error(e); alert("Gagal baca gambar: " + e.message); } 
                finally { setIsProcessing(false); }
            };

            const handleSave = async () => {
                setIsSaving(true);
                if (db && user) {
                    try {
                        const compressImageForDB = (src) => new Promise((resolve) => {
                            const img = new Image(); img.src = src; img.onload = () => {
                                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                                const max = 1024; // Resolusi ditingkatkan agar tidak buram
                                let w = img.width, h = img.height;
                                if(w>max){h*=max/w; w=max;} canvas.width=w; canvas.height=h; ctx.drawImage(img,0,0,w,h);
                                resolve(canvas.toDataURL('image/jpeg', 0.8)); // Kualitas ditingkatkan ke 80%
                            };
                        });
                        
                        const optImg = await compressImageForDB(image);
                        
                        const rec = { 
                            ...data, 
                            userId: user.uid, 
                            createdAt: serverTimestamp(), 
                            imageBase64: optImg 
                        };
                        
                        await Promise.all([
                            addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'surat_jalan_records'), rec),
                            addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'surat_jalan_logs'), rec)
                        ]);
                        
                        alert("Berhasil! Data Tajam & Tersimpan di Cloud.");
                        setImage(null); setData(prev => ({ ...prev, noSuratJalan: '' })); setManualSeq(''); setActiveTab('report');
                    } catch (e) {
                        console.error(e);
                        if(confirm("Gagal upload Cloud (Koneksi lambat). Simpan PDF lokal?")) createAndDownloadPDF(data, image);
                    }
                } else {
                    alert("Mode Offline: Simpan PDF di HP.");
                    createAndDownloadPDF(data, image);
                    setImage(null); setData(prev => ({ ...prev, noSuratJalan: '' })); setManualSeq('');
                }
                setIsSaving(false);
            };

            const handleInputChange = (field, value) => {
                setData(prev => ({ ...prev, [field]: value }));
            };

            return (
                <div className="space-y-6 pb-20">
                    {showCamera && <CameraModal onCapture={(img) => { setImage(img); setShowCamera(false); processImage(img); }} onClose={() => setShowCamera(false)} />}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl space-y-4">
                                <h3 className="font-bold text-lg text-slate-800 border-b pb-2">Pengaturan Scanner</h3>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Mesin Pembaca</label>
                                    <select value={provider} onChange={(e) => setProvider(e.target.value)} className="w-full p-3 rounded-xl border border-slate-200 bg-slate-50">
                                        <option value="gemini">SEKTE DELIVERY (Gratis/Cepat)</option>
                                        <option value="openai">OpenAI GPT-4o (Berbayar)</option>
                                        <option value="tesseract">Offline (Tanpa Internet)</option>
                                    </select>
                                </div>
                                {provider !== 'tesseract' && (
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">API Key</label>
                                        <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 font-mono text-sm" placeholder="Tempel API Key disini..." />
                                        <p className="text-[10px] text-slate-400 mt-1">Key tersimpan aman di browser Anda.</p>
                                    </div>
                                )}
                                <div className="flex justify-end gap-3 pt-2">
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-medium">Tutup</button>
                                    <button onClick={() => { localStorage.setItem('scanner_api_key', apiKey); localStorage.setItem('scanner_provider', provider); setShowSettings(false); }} className="px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold shadow-lg shadow-blue-500/30">Simpan</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="glass-panel p-5 rounded-2xl grid grid-cols-2 gap-4">
                        <div className="space-y-1">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Bulan</label>
                            <div className="relative">
                                <select value={data.bulan} onChange={(e) => setData({...data, bulan: e.target.value})} className="w-full p-3 text-sm rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-accent outline-none appearance-none">
                                    {["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"].map(m => <option key={m} value={m}>{m}</option>)}
                                </select>
                                <div className="absolute right-3 top-3 pointer-events-none text-slate-400"><Icons.Calendar /></div>
                            </div>
                        </div>
                        <div className="space-y-1">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Kategori</label>
                            <div className="relative">
                                <select value={data.kategori} onChange={(e) => setData({...data, kategori: e.target.value})} className="w-full p-3 text-sm rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-accent outline-none appearance-none">
                                    {["MI", "PASIR", "SLAG"].map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                                <div className="absolute right-3 top-3 pointer-events-none text-slate-400"><Icons.Tag /></div>
                            </div>
                        </div>
                    </div>

                    <div className="space-y-4">
                        {!image ? (
                            <button onClick={() => setShowCamera(true)} className="w-full h-48 border-2 border-dashed border-accent/40 bg-white/50 rounded-2xl flex flex-col items-center justify-center text-accent hover:bg-white hover:border-accent hover:shadow-xl hover:scale-[1.01] transition-all group">
                                <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                    <Icons.Camera className="w-8 h-8" />
                                </div>
                                <span className="font-bold text-lg text-slate-700">Scan Dokumen</span>
                                <span className="text-xs text-slate-400 mt-1 bg-slate-100 px-2 py-1 rounded-full">AI Powered: {provider === 'tesseract' ? 'Offline' : (provider === 'gemini' ? 'SEKTE DELIVERY' : 'OpenAI')}</span>
                            </button>
                        ) : (
                            <div className="relative rounded-2xl overflow-hidden shadow-2xl ring-4 ring-white">
                                <img src={image} className="w-full opacity-90" />
                                <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                                <button onClick={() => setImage(null)} className="absolute top-3 right-3 bg-white/20 backdrop-blur text-white p-2 rounded-full hover:bg-red-500 hover:text-white transition-all"><Icons.Refresh /></button>
                            </div>
                        )}
                    </div>

                    {isProcessing && (
                        <div className="bg-white p-4 rounded-xl flex items-center gap-4 shadow-lg border border-blue-100 animate-pulse">
                            <div className="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-accent"><Icons.Loader /></div>
                            <div>
                                <h4 className="font-bold text-slate-700 text-sm">Menganalisa Dokumen...</h4>
                                <p className="text-xs text-slate-400">Mohon tunggu sebentar</p>
                            </div>
                        </div>
                    )}

                    <div className="glass-panel p-5 rounded-2xl space-y-4">
                        <div className="space-y-1">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">No. Surat Jalan (Utama)</label>
                            <div className="relative">
                                <input type="text" value={data.noSuratJalan} onChange={(e) => setData({...data, noSuratJalan: e.target.value})} className="w-full p-4 pl-12 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-accent focus:border-transparent outline-none text-lg font-mono font-bold text-slate-700 shadow-inner" placeholder="..." />
                                <div className="absolute left-4 top-4 text-slate-400"><Icons.Check /></div>
                            </div>
                        </div>

                        {/* MANUAL INPUT WIDGET */}
                        <div className="bg-orange-50/50 border border-orange-100 p-3 rounded-xl">
                            <div className="flex items-center gap-2 text-orange-600 text-[10px] font-bold uppercase mb-2">
                                <Icons.Edit className="w-3 h-3"/> Input Manual Cepat
                            </div>
                            <div className="flex items-center gap-1 text-sm bg-white p-2 rounded-lg border border-orange-100 shadow-sm">
                                <span className="font-mono font-bold text-slate-400 select-none">SDO-MKI</span>
                                <span className="text-slate-300">/</span>
                                <div className="px-2 py-1 bg-slate-100 rounded text-slate-500 font-mono text-xs">{monthMap[data.bulan]}</div>
                                <span className="text-slate-300">/</span>
                                <input type="number" value={manualYear} onChange={(e) => setManualYear(e.target.value)} className="w-12 text-center bg-transparent border-b border-orange-200 focus:border-orange-500 outline-none font-mono text-slate-700" />
                                <span className="text-slate-300">/</span>
                                <input type="tel" value={manualSeq} onChange={(e) => setManualSeq(e.target.value)} placeholder="0000" className="flex-1 bg-transparent focus:bg-orange-50 rounded px-1 outline-none font-mono font-bold text-slate-800 placeholder-slate-300" />
                            </div>
                        </div>
                    </div>

                    <button onClick={handleSave} disabled={!image || isProcessing || isSaving} className="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-bold rounded-2xl shadow-xl shadow-emerald-500/30 hover:shadow-emerald-500/50 hover:scale-[1.02] disabled:opacity-50 disabled:scale-100 transition-all flex items-center justify-center gap-2 text-lg">
                        {isSaving ? <Icons.Loader /> : <Icons.Cloud />} Simpan Data
                    </button>
                </div>
            );
        };

        let app, auth, db;
        let appId = 'default-app-id';
        try {
            // KONFIGURASI PRIORITAS FIREBASE PROJECT ANDA
            const manualConfig = {
                apiKey: "AIzaSyCeiYSPF_CTathn38wrRtNANNujuNKgV_o",
                authDomain: "scan-doc-85b4d.firebaseapp.com",
                projectId: "scan-doc-85b4d",
                storageBucket: "scan-doc-85b4d.firebasestorage.app",
                messagingSenderId: "971055643255",
                appId: "1:971055643255:web:05ff764f9077e60d102472"
            };

            // Gunakan config manual jika tersedia
            if (manualConfig.apiKey && window.firebaseModules) {
                app = window.firebaseModules.initializeApp(manualConfig);
                auth = window.firebaseModules.getAuth(app);
                db = window.firebaseModules.getFirestore(app);
                appId = manualConfig.projectId;
            } 
            // Fallback ke config environment jika manual gagal
            else if (typeof __firebase_config !== 'undefined' && window.firebaseModules) {
                const config = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'logistik-tracker-app';
                app = window.firebaseModules.initializeApp(config);
                auth = window.firebaseModules.getAuth(app);
                db = window.firebaseModules.getFirestore(app);
            }
        } catch (e) { console.error("Firebase init error:", e); }

        const App = () => {
            const [activeTab, setActiveTab] = useState('scan');
            const [user, setUser] = useState(null);
            const [apiKey, setApiKey] = useState('AIzaSyBX-_zUjzlsDLnrrYwTLlbzWL4oUq-OD7Q');
            const [provider, setProvider] = useState('gemini');
            const [showSettings, setShowSettings] = useState(false);

            useEffect(() => {
                const k = localStorage.getItem('scanner_api_key'); if(k) setApiKey(k);
                const p = localStorage.getItem('scanner_provider'); if(p) setProvider(p);
                if (auth) {
                    const init = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await window.firebaseModules.signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                throw new Error("No initial token");
                            }
                        } catch (err) {
                            console.log("Token auth failed, trying anonymous...", err);
                            try {
                                await window.firebaseModules.signInAnonymously(auth);
                            } catch (anonErr) {
                                console.error("Anonymous auth failed. Check Firebase Console > Authentication > Sign-in method > Enable Anonymous.", anonErr);
                                alert("Gagal Login ke Database. Pastikan 'Anonymous Authentication' sudah diaktifkan di Firebase Console Anda.");
                            }
                        }
                    };
                    init();
                    window.firebaseModules.onAuthStateChanged(auth, setUser);
                }
            }, []);

            return (
                <div className={`flex flex-col h-screen mx-auto shadow-2xl overflow-hidden bg-[#f1f5f9] transition-all duration-500 ease-in-out ${activeTab === 'scan' ? 'max-w-md w-full' : 'w-full md:max-w-7xl'}`}>
                    <div className="bg-slate-900 p-6 pt-8 pb-10 text-white text-center relative flex-shrink-0 rounded-b-[2.5rem] shadow-2xl z-10 transition-all duration-500">
                        <div className="absolute inset-0 bg-gradient-to-br from-blue-600/20 to-purple-600/20 rounded-b-[2.5rem]"></div>
                        <button onClick={() => setShowSettings(true)} className="absolute top-5 right-5 p-2 bg-white/10 backdrop-blur rounded-full hover:bg-white/20 transition-all"><Icons.Key /></button>
                        <h1 className="text-2xl font-bold relative z-10 flex items-center justify-center gap-3 tracking-tight">
                            <span className="bg-gradient-to-r from-blue-400 to-teal-300 bg-clip-text text-transparent"><Icons.Brain /></span> SEKTE DELIVERY
                        </h1>
                        <p className="text-slate-400 text-xs mt-2 font-medium tracking-wide uppercase">Smart Logistics Scanner</p>
                        <div className={`absolute bottom-3 left-1/2 -translate-x-1/2 text-[10px] px-3 py-1 rounded-full flex items-center gap-1.5 ${user ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30' : 'bg-red-500/20 text-red-300 border border-red-500/30'}`}>
                            <div className={`w-1.5 h-1.5 rounded-full ${user ? 'bg-emerald-400 animate-pulse' : 'bg-red-400'}`}></div>
                            {user ? 'CLOUD CONNECTED' : 'OFFLINE MODE'}
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-5 scroll-smooth">
                        {activeTab === 'scan' ? (
                            <div className="max-w-md mx-auto">
                                <ScannerView user={user} db={db} appId={appId} apiKey={apiKey} setApiKey={setApiKey} provider={provider} setProvider={setProvider} showSettings={showSettings} setShowSettings={setShowSettings} setActiveTab={setActiveTab} />
                            </div>
                        ) : (
                            <ReportsView db={db} user={user} appId={appId} />
                        )}
                    </div>

                    <div className="bg-white border-t border-slate-100 p-2 pb-safe flex justify-center items-center gap-8 md:gap-16 z-20 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] transition-all">
                        <button onClick={() => setActiveTab('scan')} className={`flex flex-col items-center gap-1 px-6 py-2 rounded-2xl transition-all duration-300 ${activeTab === 'scan' ? 'text-accent bg-blue-50 scale-105' : 'text-slate-400 hover:text-slate-600'}`}>
                            <Icons.Home className={activeTab === 'scan' ? 'fill-current' : ''} />
                            <span className="text-[10px] font-bold">Scan</span>
                        </button>
                        <button onClick={() => setActiveTab('report')} className={`flex flex-col items-center gap-1 px-6 py-2 rounded-2xl transition-all duration-300 ${activeTab === 'report' ? 'text-accent bg-blue-50 scale-105' : 'text-slate-400 hover:text-slate-600'}`}>
                            <Icons.List className={activeTab === 'report' ? 'stroke-[3px]' : ''} />
                            <span className="text-[10px] font-bold">Laporan</span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
